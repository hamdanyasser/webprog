<%- include('partials/head') %>
<title>Loyalty Settings - Admin - PowerShare</title>

    <%- include('partials/navbar') %>

    <div class="container my-5">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 mb-0">⚙️ Loyalty & Rewards Settings</h1>
                <p class="text-muted">Configure loyalty program, discounts, and fees</p>
            </div>
            <a href="/dashboard" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>

        <!-- Success/Error Messages -->
        <div id="alert-container"></div>

        <!-- Loyalty Points Settings -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-star"></i> Loyalty Points Configuration</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Points Per Dollar Spent</label>
                        <input type="number" class="form-control" id="loyalty_points_per_dollar" min="0" step="0.1">
                        <small class="text-muted">How many points users earn per $1 spent</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Point Redemption Value ($)</label>
                        <input type="number" class="form-control" id="points_redemption_value" min="0" step="0.001">
                        <small class="text-muted">Dollar value of each point when redeemed (e.g., 0.01 = 100pts = $1)</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Minimum Points to Redeem</label>
                        <input type="number" class="form-control" id="min_points_to_redeem" min="0" step="10">
                        <small class="text-muted">Minimum points required to redeem rewards</small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Max Points Redemption (%)</label>
                        <input type="number" class="form-control" id="max_points_redemption_percentage" min="0" max="100" step="5">
                        <small class="text-muted">Maximum percentage of bill payable with points</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Early Payment Discount Settings -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> Early Payment Discount</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Enable Early Payment Discount</label>
                        <select class="form-select" id="early_payment_discount_enabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Discount Percentage (%)</label>
                        <input type="number" class="form-control" id="early_payment_discount_percentage" min="0" max="100" step="0.5">
                        <small class="text-muted">Discount % for early payments</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Days Before Due Date</label>
                        <input type="number" class="form-control" id="early_payment_days_threshold" min="1" step="1">
                        <small class="text-muted">Days before due date to qualify</small>
                    </div>
                </div>
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle"></i>
                    <strong>Example:</strong> If set to 2% discount and 5 days threshold, users who pay 5+ days before due date get 2% off.
                </div>
            </div>
        </div>

        <!-- Late Payment Fee Settings -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Late Payment Fees</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Enable Late Payment Fees</label>
                        <select class="form-select" id="late_payment_fee_enabled">
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Late Fee Percentage (%)</label>
                        <input type="number" class="form-control" id="late_payment_fee_percentage" min="0" max="100" step="0.5">
                        <small class="text-muted">Fee % applied to overdue bills</small>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Grace Period (Days)</label>
                        <input type="number" class="form-control" id="late_payment_grace_period_days" min="0" step="1">
                        <small class="text-muted">Days after due date before fee applies</small>
                    </div>
                </div>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> Late fees are applied automatically via scheduled task. Set grace period carefully.
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-end">
            <button type="button" class="btn btn-secondary me-2" onclick="loadSettings()">
                <i class="fas fa-undo"></i> Reset
            </button>
            <button type="button" class="btn btn-primary" onclick="saveAllSettings()">
                <i class="fas fa-save"></i> Save All Settings
            </button>
        </div>

        <!-- Statistics -->
        <div class="card shadow-sm mt-5">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Loyalty Program Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center" id="stats-container">
                    <div class="col-md-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
        let currentSettings = {};

        async function loadSettings() {
            try {
                const response = await fetch('/api/loyalty/settings', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load settings');

                const data = await response.json();
                currentSettings = data.data.settings;

                // Populate form fields
                for (const [key, value] of Object.entries(currentSettings)) {
                    const input = document.getElementById(key);
                    if (input) {
                        input.value = value;
                    }
                }

                showAlert('Settings loaded successfully', 'success');
            } catch (error) {
                console.error('Error loading settings:', error);
                showAlert('Failed to load settings', 'danger');
            }
        }

        async function saveAllSettings() {
            try {
                const settingsToUpdate = [
                    'loyalty_points_per_dollar',
                    'points_redemption_value',
                    'min_points_to_redeem',
                    'max_points_redemption_percentage',
                    'early_payment_discount_enabled',
                    'early_payment_discount_percentage',
                    'early_payment_days_threshold',
                    'late_payment_fee_enabled',
                    'late_payment_fee_percentage',
                    'late_payment_grace_period_days'
                ];

                for (const key of settingsToUpdate) {
                    const input = document.getElementById(key);
                    if (input) {
                        const value = input.type === 'checkbox' ? input.checked : input.value;

                        await fetch('/api/loyalty/settings', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                setting_key: key,
                                setting_value: value
                            }),
                            credentials: 'include'
                        });
                    }
                }

                showAlert('All settings saved successfully!', 'success');
                await loadStatistics();
            } catch (error) {
                console.error('Error saving settings:', error);
                showAlert('Failed to save settings', 'danger');
            }
        }

        async function loadStatistics() {
            try {
                const response = await fetch('/api/loyalty/statistics', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load statistics');

                const data = await response.json();
                const stats = data.data.statistics;

                document.getElementById('stats-container').innerHTML = `
                    <div class="col-md-3">
                        <h3 class="text-primary">${stats.total_issued?.toLocaleString() || 0}</h3>
                        <p class="text-muted small mb-0">Total Points Issued</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-danger">${stats.total_redeemed?.toLocaleString() || 0}</h3>
                        <p class="text-muted small mb-0">Total Points Redeemed</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-success">${(stats.total_issued - stats.total_redeemed)?.toLocaleString() || 0}</h3>
                        <p class="text-muted small mb-0">Points in Circulation</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-info">${stats.total_transactions?.toLocaleString() || 0}</h3>
                        <p class="text-muted small mb-0">Total Transactions</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadStatistics();
        });
    </script>

<%- include('partials/footer') %>