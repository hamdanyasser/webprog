<%- include('partials/head') %>
<%- include('partials/dashboard-navbar', { dashboardTitle: '', navbarClass: 'bg-primary' }) %>

<div class="container-fluid">
    <div class="row">
        <%- include('partials/sidebar-user', { activePage: 'schedule' }) %>

        <div class="col-md-9 col-lg-10 px-4 py-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold mb-1">
                        <i class="fas fa-calendar-alt text-danger me-2"></i>Power Outage Schedule
                    </h2>
                    <p class="text-muted mb-0">Stay informed about upcoming power cuts</p>
                </div>
            </div>

            <div class="alert alert-success d-flex align-items-center mb-4" role="alert" id="statusAlert">
                <i class="fas fa-plug fa-2x me-3"></i>
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-1">Power Currently Available</h5>
                    <p class="mb-0">Generator is running. Next outage in <strong id="nextOutageTime">--</strong></p>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-clock me-2 text-primary"></i>Today's Schedule - <span id="todayDate"></span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="todayScheduleContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Loading today's schedule...</p>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="mb-2 small text-muted">Day Progress</label>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-success" id="dayProgress" style="width: 0%">
                                <span id="progressText">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-calendar-week me-2 text-success"></i>This Week's Schedule
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                            <tr>
                                <th>Day</th>
                                <th>Morning Cut</th>
                                <th>Afternoon Cut</th>
                                <th>Evening Cut</th>
                                <th>Total Hours</th>
                            </tr>
                            </thead>
                            <tbody id="weeklyScheduleTable">
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="row g-3">
                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h5 class="fw-bold mb-0">
                                <i class="fas fa-bell me-2 text-info"></i>Notification Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailNotif" checked>
                                <label class="form-check-label" for="emailNotif">
                                    <strong>Email Notifications</strong>
                                    <small class="d-block text-muted">Receive outage alerts via email</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="smsNotif" checked>
                                <label class="form-check-label" for="smsNotif">
                                    <strong>SMS Notifications</strong>
                                    <small class="d-block text-muted">Get text messages for urgent alerts</small>
                                </label>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="reminderNotif" checked>
                                <label class="form-check-label" for="reminderNotif">
                                    <strong>30-Min Reminders</strong>
                                    <small class="d-block text-muted">Alert me 30 minutes before outages</small>
                                </label>
                            </div>
                            <button class="btn btn-primary mt-3" onclick="saveNotificationPreferences()">
                                <i class="fas fa-save me-2"></i>Save Preferences
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h5 class="fw-bold mb-0">
                                <i class="fas fa-info-circle me-2 text-warning"></i>Important Notes
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>Pro Tip:</strong> Plan your day around outage schedules to maximize productivity.
                            </div>
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Schedules may change due to maintenance or emergencies.
                            </div>
                            <div class="alert alert-success mb-0">
                                <i class="fas fa-check-circle me-2"></i>
                                Your generator subscription includes 24/7 customer support.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function() {
        document.getElementById('todayDate').textContent = new Date().toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        await loadSchedules();
        updateDayProgress();
        setInterval(updateDayProgress, 60000); 
    });

    async function loadSchedules() {
        try {
            const subscriptionResponse = await fetch('/api/subscriptions/my');
            const subscriptionData = await subscriptionResponse.json();

            if (!subscriptionData.success || !subscriptionData.data || subscriptionData.data.length === 0) {
                document.getElementById('todayScheduleContainer').innerHTML =
                    '<p class="text-center text-muted py-4">You are not subscribed to any generator yet.</p>';
                document.getElementById('weeklyScheduleTable').innerHTML =
                    '<tr><td colspan="5" class="text-center py-4 text-muted">No subscription found</td></tr>';
                return;
            }

            const generatorId = subscriptionData.data[0].generator_id;

            const todayResponse = await fetch(`/api/schedules/${generatorId}/today`);
            const todayData = await todayResponse.json();

            if (todayData.success) {
                displayTodaySchedule(todayData.data);
            }

            const upcomingResponse = await fetch(`/api/schedules/${generatorId}/upcoming?days=7`);
            const upcomingData = await upcomingResponse.json();

            if (upcomingData.success) {
                displayWeeklySchedule(upcomingData.data);
            }

        } catch (error) {
            console.error('Load schedules error:', error);
            document.getElementById('todayScheduleContainer').innerHTML =
                '<p class="text-center text-danger">Failed to load schedules</p>';
        }
    }

    function displayTodaySchedule(schedules) {
        const container = document.getElementById('todayScheduleContainer');

        if (!schedules || schedules.length === 0) {
            container.innerHTML = '<p class="text-center text-muted py-4">No outages scheduled for today</p>';
            return;
        }

        container.innerHTML = `
        <div class="row g-3">
            ${schedules.map((schedule, index) => {
            const colors = ['danger', 'warning', 'info'];
            const labels = ['Morning', 'Afternoon', 'Evening'];
            return `
                    <div class="col-md-4">
                        <div class="schedule-card p-3 bg-${colors[index % 3]} bg-opacity-10 border border-${colors[index % 3]} rounded">
                            <div class="d-flex align-items-center mb-3">
                                <div class="schedule-icon bg-${colors[index % 3]} me-3">
                                    <i class="fas fa-power-off text-white"></i>
                                </div>
                                <div>
                                    <h6 class="fw-bold mb-0 text-${colors[index % 3]}">${getOutageStatus(schedule)}</h6>
                                    <small class="text-muted">${labels[index % 3]} Outage</small>
                                </div>
                            </div>
                            <div class="mb-2">
                                <i class="fas fa-clock text-${colors[index % 3]} me-2"></i>
                                <strong>${formatTime(schedule.start_time)} - ${formatTime(schedule.end_time)}</strong>
                            </div>
                            <div class="mb-2">
                                <i class="fas fa-hourglass-half text-${colors[index % 3]} me-2"></i>
                                Duration: ${calculateDuration(schedule.start_time, schedule.end_time)} hours
                            </div>
                            ${getScheduleBadge(schedule)}
                        </div>
                    </div>
                `;
        }).join('')}
        </div>
    `;
    }

    function displayWeeklySchedule(schedules) {
        const tbody = document.getElementById('weeklyScheduleTable');

        if (!schedules || schedules.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No schedules available</td></tr>';
            return;
        }

        const groupedByDate = schedules.reduce((acc, schedule) => {
            const date = schedule.outage_date;
            if (!acc[date]) acc[date] = [];
            acc[date].push(schedule);
            return acc;
        }, {});

        tbody.innerHTML = Object.entries(groupedByDate).map(([date, daySchedules], index) => {
            const isToday = new Date(date).toDateString() === new Date().toDateString();
            const dayName = new Date(date).toLocaleDateString('en-US', { weekday: 'long' });

            const morning = daySchedules.find(s => parseInt(s.start_time.split(':')[0]) < 12) || { start_time: '--', end_time: '--' };
            const afternoon = daySchedules.find(s => {
                const hour = parseInt(s.start_time.split(':')[0]);
                return hour >= 12 && hour < 18;
            }) || { start_time: '--', end_time: '--' };
            const evening = daySchedules.find(s => parseInt(s.start_time.split(':')[0]) >= 18) || { start_time: '--', end_time: '--' };

            const totalHours = daySchedules.reduce((sum, s) => sum + calculateDuration(s.start_time, s.end_time), 0);

            return `
            <tr class="${isToday ? 'table-primary' : ''}">
                <td><strong>${isToday ? 'Today (' + dayName + ')' : dayName}</strong></td>
                <td>${formatTime(morning.start_time)} - ${formatTime(morning.end_time)}</td>
                <td>${formatTime(afternoon.start_time)} - ${formatTime(afternoon.end_time)}</td>
                <td>${formatTime(evening.start_time)} - ${formatTime(evening.end_time)}</td>
                <td><strong>${totalHours.toFixed(1)} hrs</strong></td>
            </tr>
        `;
        }).join('');
    }

    function updateDayProgress() {
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const totalMinutes = hours * 60 + minutes;
        const percentage = (totalMinutes / 1440) * 100; 

        const progressBar = document.getElementById('dayProgress');
        const progressText = document.getElementById('progressText');

        progressBar.style.width = percentage + '%';
        progressText.textContent = `${hours}:${minutes.toString().padStart(2, '0')} - Power Available`;
    }

    function getOutageStatus(schedule) {
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();

        const startParts = schedule.start_time.split(':');
        const endParts = schedule.end_time.split(':');
        const startMinutes = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
        const endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);

        if (currentTime >= startMinutes && currentTime <= endMinutes) {
            return 'In Progress';
        } else if (currentTime < startMinutes) {
            return 'Upcoming';
        } else {
            return 'Completed';
        }
    }

    function getScheduleBadge(schedule) {
        const status = getOutageStatus(schedule);
        const badges = {
            'In Progress': '<span class="badge bg-danger">In Progress</span>',
            'Upcoming': '<span class="badge bg-warning">Upcoming</span>',
            'Completed': '<span class="badge bg-secondary">Completed</span>'
        };
        return badges[status] || '';
    }

    function formatTime(time) {
        if (time === '--') return '--';
        const parts = time.split(':');
        const hours = parseInt(parts[0]);
        const minutes = parts[1];
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const displayHours = hours % 12 || 12;
        return `${displayHours}:${minutes} ${ampm}`;
    }

    function calculateDuration(startTime, endTime) {
        if (startTime === '--' || endTime === '--') return 0;

        const startParts = startTime.split(':');
        const endParts = endTime.split(':');

        const startMinutes = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
        const endMinutes = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);

        return (endMinutes - startMinutes) / 60;
    }

    async function saveNotificationPreferences() {
        const emailNotif = document.getElementById('emailNotif').checked;
        const smsNotif = document.getElementById('smsNotif').checked;
        const reminderNotif = document.getElementById('reminderNotif').checked;

        try {
            const response = await fetch('/api/users/preferences', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email_notifications: emailNotif,
                    sms_notifications: smsNotif,
                    reminder_notifications: reminderNotif
                })
            });

            const result = await response.json();

            if (result.success) {
                alert('Notification preferences saved successfully!');
            } else {
                alert('Failed to save preferences: ' + result.message);
            }
        } catch (error) {
            console.error('Save preferences error:', error);
            alert('Failed to save preferences. Please try again.');
        }
    }
</script>

<%- include('partials/footer') %>