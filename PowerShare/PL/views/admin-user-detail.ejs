<%- include('partials/head', { title: 'User Details - PowerShare' }) %>

<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/dashboard">
            <i class="fas fa-shield-alt"></i> PowerShare Admin
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard">
                        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-1"></i>
                        <span><%= user.full_name || 'Admin' %></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="/profile">
                                <i class="fas fa-user me-2"></i>Profile Management
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="/logout">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold mb-1">User Details</h2>
                    <p class="text-muted mb-0">View and manage user information</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>User Information</h5>
                </div>
                <div class="card-body" id="userInfoCard">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold mb-0"><i class="fas fa-bolt me-2"></i>Subscriptions</h5>
                </div>
                <div class="card-body">
                    <div id="subscriptionsTable">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold mb-0"><i class="fas fa-credit-card me-2"></i>Payment History</h5>
                </div>
                <div class="card-body">
                    <div id="paymentsTable">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include('partials/footer') %>

<script>
    const userId = <%= userId %>;

    document.addEventListener('DOMContentLoaded', function() {
        loadUserDetails();
    });

    async function loadUserDetails() {
        try {
            const response = await fetch(`/api/admin/users/${userId}`);
            const data = await response.json();

            if (!data.success || !data.data) {
                document.getElementById('userInfoCard').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        User not found or has been deleted.
                    </div>
                `;
                document.getElementById('subscriptionsTable').innerHTML = `
                    <div class="alert alert-warning">No data available for deleted user.</div>
                `;
                document.getElementById('paymentsTable').innerHTML = `
                    <div class="alert alert-warning">No data available for deleted user.</div>
                `;
                return;
            }

            const userDetail = data.data;
            const userInfoCard = document.getElementById('userInfoCard');

            userInfoCard.innerHTML = `
                <div class="text-center mb-3">
                    <div class="avatar-circle mx-auto mb-3">
                        <i class="fas fa-user fa-3x text-primary"></i>
                    </div>
                    <h5 class="mb-1">${userDetail.full_name}</h5>
                    <span class="badge bg-info">${capitalizeFirst(userDetail.role)}</span>
                </div>
                <hr>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Email</small>
                    <div>${userDetail.email}</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Phone</small>
                    <div>${userDetail.phone || 'Not provided'}</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Address</small>
                    <div>${userDetail.address || 'Not provided'}</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Member Since</small>
                    <div>${formatDate(userDetail.created_at)}</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">User ID</small>
                    <div>#${userDetail.user_id}</div>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Active Subscriptions</span>
                    <span class="fw-bold">${userDetail.subscriptions ? userDetail.subscriptions.length : 0}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Pending Bills</span>
                    <span class="fw-bold ${userDetail.pending_bills && userDetail.pending_bills.length > 0 ? 'text-warning' : ''}">${userDetail.pending_bills ? userDetail.pending_bills.length : 0}</span>
                </div>
            `;
            
            loadSubscriptions(userDetail.subscriptions);
            
            loadPaymentsAndBills(userDetail.payments, userDetail.pending_bills);
            
        } catch (error) {
            console.error('Load user error:', error);
            document.getElementById('userInfoCard').innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error loading user details: ${error.message}
                </div>
            `;
        }
    }

    function loadSubscriptions(subscriptions) {
        const subscriptionsTable = document.getElementById('subscriptionsTable');
        
        if (!subscriptions || subscriptions.length === 0) {
            subscriptionsTable.innerHTML = `
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    This user has no active subscriptions.
                </div>
            `;
            return;
        }
        
        subscriptionsTable.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>Generator</th>
                            <th>Plan</th>
                            <th>Monthly Price</th>
                            <th>Status</th>
                            <th>Start Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${subscriptions.map(sub => `
                            <tr>
                                <td>${sub.generator_name}</td>
                                <td><span class="badge bg-primary">${sub.plan_name} (${sub.amperage}A)</span></td>
                                <td>$${parseFloat(sub.monthly_price).toFixed(2)}/mo</td>
                                <td><span class="badge ${sub.status === 'active' ? 'bg-success' : 'bg-secondary'}">${capitalizeFirst(sub.status)}</span></td>
                                <td>${formatDate(sub.start_date)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    function loadPaymentsAndBills(payments, pendingBills) {
        const paymentsTable = document.getElementById('paymentsTable');
        
        let html = '';
        
        if (pendingBills && pendingBills.length > 0) {
            html += `
                <div class="alert alert-warning mb-3">
                    <strong><i class="fas fa-exclamation-triangle me-2"></i>Pending Bills (${pendingBills.length})</strong>
                </div>
                <div class="table-responsive mb-4">
                    <table class="table table-sm table-bordered">
                        <thead class="table-warning">
                            <tr>
                                <th>Bill ID</th>
                                <th>Generator</th>
                                <th>Amount</th>
                                <th>Due Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pendingBills.map(bill => `
                                <tr>
                                    <td>#${bill.bill_id}</td>
                                    <td>${bill.generator_name}</td>
                                    <td class="fw-bold">$${parseFloat(bill.amount).toFixed(2)}</td>
                                    <td>${formatDate(bill.due_date)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        if (!payments || payments.length === 0) {
            html += `
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    No payment history available.
                </div>
            `;
        } else {
            html += `
                <h6 class="fw-bold mb-3">Recent Payments</h6>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Payment ID</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${payments.map(payment => `
                                <tr>
                                    <td>#${payment.payment_id}</td>
                                    <td class="fw-bold">$${parseFloat(payment.amount).toFixed(2)}</td>
                                    <td>${capitalizeFirst(payment.payment_method.replace('_', ' '))}</td>
                                    <td>${formatDate(payment.payment_date)}</td>
                                    <td><span class="badge bg-success">${capitalizeFirst(payment.status)}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        paymentsTable.innerHTML = html;
    }

    function formatDate(dateString) {
        if (!dateString) return '--';
        return new Date(dateString).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }
    
    function capitalizeFirst(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
</script>

<style>
    .avatar-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #f0f8ff;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
</body>
</html>

