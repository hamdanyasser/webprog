<%- include('partials/head') %>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="#" onclick="goBack()">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</nav>

<div class="container py-5">
    <div class="row">
        <div class="col-md-3 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="position-relative d-inline-block">
                            <% if (user.profile_image) { %>
                                <img id="sidebarProfileImage" src="<%= user.profile_image %>" alt="Profile" 
                                     style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid #0d6efd;">
                            <% } else { %>
                                <div class="avatar-circle mb-3" id="sidebarAvatar" style="width: 100px; height: 100px; font-size: 40px; margin: 0 auto; line-height: 100px;">
                                    <span id="avatarInitials"><%= user.full_name.split(' ').map(n => n[0]).join('') %></span>
                                </div>
                            <% } %>
                        </div>
                        <h5 class="fw-bold mb-0"><%= user.full_name %></h5>
                        <small class="text-muted"><%= user.role %></small>
                    </div>
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#profile" data-bs-toggle="tab">
                                <i class="fas fa-user me-2"></i>Profile
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#security" data-bs-toggle="tab">
                                <i class="fas fa-lock me-2"></i>Security
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#notifications-settings" data-bs-toggle="tab">
                                <i class="fas fa-bell me-2"></i>Notifications
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#preferences" data-bs-toggle="tab">
                                <i class="fas fa-cog me-2"></i>Preferences
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="profile">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h5 class="fw-bold mb-0">
                                <i class="fas fa-user me-2"></i>Profile Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="profileForm" enctype="multipart/form-data">
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Profile Picture</label>
                                    <div class="d-flex align-items-center">
                                        <div class="position-relative me-3">
                                            <% if (user.profile_image) { %>
                                                <img id="profileImagePreview" src="<%= user.profile_image %>" alt="Profile" 
                                                     style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #dee2e6;">
                                            <% } else { %>
                                                <div id="profileImagePreview" style="width: 100px; height: 100px; border-radius: 50%; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                                                    <i class="fas fa-user fa-2x text-muted"></i>
                                                </div>
                                            <% } %>
                                        </div>
                                        <div class="flex-grow-1">
                                            <input type="file" class="form-control mb-2" id="profileImageInput" name="profile_image" accept="image/*">
                                            <small class="text-muted">JPG, PNG, or GIF (Max 5MB)</small>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="fullName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="fullName" value="<%= user.full_name %>" required>
                                </div>

                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" value="<%= user.email %>" readonly>
                                    <small class="text-muted">Email cannot be changed</small>
                                </div>

                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone" value="<%= user.phone || '' %>">
                                </div>

                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <textarea class="form-control" id="address" rows="2"><%= user.address || '' %></textarea>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="security">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h5 class="fw-bold mb-0">
                                <i class="fas fa-lock me-2"></i>Security Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <h6 class="fw-bold mb-3">Change Password</h6>
                            <form id="passwordForm">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">Current Password</label>
                                    <input type="password" class="form-control" id="currentPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="newPassword" minlength="8" required>
                                    <small class="text-muted">
                                        Password must be at least 8 characters with uppercase, lowercase, number, and special character
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                    <input type="password" class="form-control" id="confirmPassword" minlength="8" required>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-key me-2"></i>Change Password
                                </button>
                            </form>

                            <hr class="my-4">

                            <h6 class="fw-bold mb-3">Two-Factor Authentication (2FA)</h6>
                            <p class="text-muted small mb-3">
                                Add an extra layer of security to your account. When enabled, you'll need to enter a code sent to your email in addition to your password.
                            </p>

                            <div id="twoFactorStatus" class="mb-3">
                                <div class="d-flex align-items-center justify-content-between p-3 border rounded">
                                    <div>
                                        <strong id="twoFactorStatusText">Loading...</strong>
                                        <small class="d-block text-muted" id="twoFactorStatusDescription"></small>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="twoFactorToggle" style="width: 3rem; height: 1.5rem;">
                                    </div>
                                </div>
                            </div>

                            <div id="backupCodesSection" class="d-none">
                                <div class="alert alert-warning">
                                    <h6 class="fw-bold mb-2">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Save Your Backup Codes
                                    </h6>
                                    <p class="small mb-2">Store these codes in a safe place. Each code can only be used once.</p>
                                    <div id="backupCodesList" class="font-monospace small bg-white p-3 rounded border">
                                        <!-- Backup codes will be displayed here -->
                                    </div>
                                    <button class="btn btn-sm btn-secondary mt-2" onclick="printBackupCodes()">
                                        <i class="fas fa-print me-1"></i>Print Codes
                                    </button>
                                    <button class="btn btn-sm btn-success mt-2" onclick="downloadBackupCodes()">
                                        <i class="fas fa-download me-1"></i>Download Codes
                                    </button>
                                </div>
                            </div>

                            <div id="disableTwoFactorSection" class="d-none">
                                <div class="alert alert-danger">
                                    <h6 class="fw-bold mb-2">
                                        <i class="fas fa-shield-alt me-2"></i>Disable Two-Factor Authentication
                                    </h6>
                                    <p class="small mb-3">Enter your password to confirm disabling 2FA.</p>
                                    <form id="disableTwoFactorForm">
                                        <div class="mb-3">
                                            <input type="password" class="form-control" id="disable2FAPassword" placeholder="Enter your password" required>
                                        </div>
                                        <button type="submit" class="btn btn-danger btn-sm">
                                            <i class="fas fa-times-circle me-1"></i>Disable 2FA
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="cancelDisable2FA()">
                                            Cancel
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="notifications-settings">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h5 class="fw-bold mb-0">
                                <i class="fas fa-bell me-2"></i>Notification Preferences
                            </h5>
                        </div>
                        <div class="card-body">
                            <h6 class="fw-bold mb-3">Email Notifications</h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                <label class="form-check-label" for="emailNotifications">
                                    <strong>Email Notifications</strong>
                                    <small class="d-block text-muted">Receive updates and alerts via email</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="outageAlerts" checked>
                                <label class="form-check-label" for="outageAlerts">
                                    <strong>Outage Alerts</strong>
                                    <small class="d-block text-muted">Get notified about power outages</small>
                                </label>
                            </div>

                            <hr class="my-4">

                            <h6 class="fw-bold mb-3">SMS Notifications</h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="smsNotifications">
                                <label class="form-check-label" for="smsNotifications">
                                    <strong>SMS Alerts</strong>
                                    <small class="d-block text-muted">Receive critical alerts via text message</small>
                                </label>
                            </div>

                            <button class="btn btn-primary mt-3" onclick="saveNotificationSettings()">
                                <i class="fas fa-save me-2"></i>Save Preferences
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="preferences">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h5 class="fw-bold mb-0">
                                <i class="fas fa-cog me-2"></i>Display Preferences
                            </h5>
                        </div>
                        <div class="card-body">
                            <h6 class="fw-bold mb-3">Theme Settings</h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="darkModeToggle">
                                <label class="form-check-label" for="darkModeToggle">
                                    <strong>Dark Mode</strong>
                                    <small class="d-block text-muted">Switch between light and dark theme</small>
                                </label>
                            </div>

                            <div class="alert alert-info mt-3" role="alert">
                                <i class="fas fa-info-circle me-2"></i>
                                Your theme preference will be saved and applied across all pages.
                            </div>

                            <button class="btn btn-primary mt-3" onclick="saveThemePreferences()">
                                <i class="fas fa-save me-2"></i>Save Preferences
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function goBack() {
        window.history.back();
    }

    document.getElementById('profileImageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('profileImagePreview');
        
        if (file) {
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                this.value = '';
                return;
            }
            
            if (!file.type.match('image.*')) {
                alert('Please select an image file');
                this.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData();
        formData.append('full_name', document.getElementById('fullName').value);
        formData.append('phone', document.getElementById('phone').value);
        formData.append('address', document.getElementById('address').value);
        
        const profileImageFile = document.getElementById('profileImageInput').files[0];
        if (profileImageFile) {
            formData.append('profile_image', profileImageFile);
        }

        try {
            const response = await fetch('/api/users/profile', {
                method: 'PUT',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                alert('Profile updated successfully!');
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                alert('Failed to update profile: ' + result.message);
            }
        } catch (error) {
            console.error('Update error:', error);
            alert('Failed to update profile');
        }
    });

    function validatePassword(password) {
        const errors = [];

        if (password.length < 8) {
            errors.push('Password must be at least 8 characters long');
        }

        if (!/[A-Z]/.test(password)) {
            errors.push('Password must contain at least one uppercase letter');
        }

        if (!/[a-z]/.test(password)) {
            errors.push('Password must contain at least one lowercase letter');
        }

        if (!/[0-9]/.test(password)) {
            errors.push('Password must contain at least one number');
        }

        if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
            errors.push('Password must contain at least one special character (!@#$%^&*...)');
        }

        return errors;
    }

    function showValidationError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const existingError = field.parentElement.querySelector('.validation-error');

        if (existingError) {
            existingError.remove();
        }

        field.classList.add('is-invalid');

        const errorDiv = document.createElement('div');
        errorDiv.className = 'validation-error text-danger small mt-1';
        errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i>${message}`;

        field.parentElement.appendChild(errorDiv);
    }

    function clearValidationError(fieldId) {
        const field = document.getElementById(fieldId);
        const existingError = field.parentElement.querySelector('.validation-error');

        if (existingError) {
            existingError.remove();
        }

        field.classList.remove('is-invalid');
    }

    document.getElementById('newPassword').addEventListener('input', function() {
        const errors = validatePassword(this.value);

        if (errors.length > 0) {
            showValidationError('newPassword', errors.join('<br>'));
        } else if (this.value) {
            clearValidationError('newPassword');
        }
    });

    document.getElementById('confirmPassword').addEventListener('input', function() {
        const newPassword = document.getElementById('newPassword').value;

        if (this.value && this.value !== newPassword) {
            showValidationError('confirmPassword', 'Passwords do not match');
        } else if (this.value) {
            clearValidationError('confirmPassword');
        }
    });

    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        clearValidationError('currentPassword');
        clearValidationError('newPassword');
        clearValidationError('confirmPassword');

        let hasErrors = false;

        const passwordErrors = validatePassword(newPassword);
        if (passwordErrors.length > 0) {
            showValidationError('newPassword', passwordErrors.join('<br>'));
            hasErrors = true;
        }

        if (newPassword !== confirmPassword) {
            showValidationError('confirmPassword', 'Passwords do not match');
            hasErrors = true;
        }

        if (hasErrors) {
            return;
        }

        try {
            const response = await fetch('/api/auth/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });

            const result = await response.json();

            if (result.success) {
                alert('Password changed successfully!');
                this.reset();
            } else {
                alert('Failed to change password: ' + result.message);
            }
        } catch (error) {
            console.error('Password change error:', error);
            alert('Failed to change password. Please try again.');
        }
    });

    async function loadNotificationPreferences() {
        try {
            const response = await fetch('/api/users/settings/notifications', {
                credentials: 'include'
            });

            const result = await response.json();

            if (result.success && result.data) {
                const preferences = result.data;

                document.getElementById('emailNotifications').checked = preferences.email_notifications;
                document.getElementById('outageAlerts').checked = preferences.outage_alerts;
                document.getElementById('smsNotifications').checked = preferences.sms_notifications;

                if (preferences.theme === 'dark') {
                    document.getElementById('darkModeToggle').checked = true;
                }
            }
        } catch (error) {
            console.error('Load preferences error:', error);
        }
    }

    async function saveNotificationSettings() {
        const emailNotifications = document.getElementById('emailNotifications').checked;
        const outageAlerts = document.getElementById('outageAlerts').checked;
        const smsNotifications = document.getElementById('smsNotifications').checked;

        try {
            const response = await fetch('/api/users/settings/notifications', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    email_notifications: emailNotifications,
                    outage_alerts: outageAlerts,
                    sms_notifications: smsNotifications,
                    theme: document.getElementById('darkModeToggle').checked ? 'dark' : 'light'
                })
            });

            const result = await response.json();

            if (result.success) {
                alert('Notification settings saved successfully!');
            } else {
                alert('Failed to save notification settings: ' + result.message);
            }
        } catch (error) {
            console.error('Save notification settings error:', error);
            alert('Failed to save notification settings. Please try again.');
        }
    }

    async function saveThemePreferences() {
        const darkMode = document.getElementById('darkModeToggle').checked;
        const theme = darkMode ? 'dark' : 'light';

        try {
            const response = await fetch('/api/users/settings/notifications', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    email_notifications: document.getElementById('emailNotifications').checked,
                    outage_alerts: document.getElementById('outageAlerts').checked,
                    sms_notifications: document.getElementById('smsNotifications').checked,
                    theme: theme
                })
            });

            const result = await response.json();

            if (result.success) {
                alert('Theme preferences saved successfully!');
                if (typeof window.applyTheme === 'function') {
                    window.applyTheme(theme);
                }
            } else {
                alert('Failed to save theme preferences: ' + result.message);
            }
        } catch (error) {
            console.error('Save theme preferences error:', error);
            alert('Failed to save theme preferences. Please try again.');
        }
    }

    function toggleThemeInstantly() {
        const darkMode = document.getElementById('darkModeToggle').checked;
        const theme = darkMode ? 'dark' : 'light';

        if (typeof window.applyTheme === 'function') {
            window.applyTheme(theme);
        }
    }

    // Two-Factor Authentication Functions
    let backupCodesData = [];

    async function load2FAStatus() {
        try {
            const response = await fetch('/api/auth/2fa/status', {
                credentials: 'include'
            });

            const result = await response.json();

            if (result.success) {
                const { enabled, backupCodesRemaining } = result.data;
                const toggle = document.getElementById('twoFactorToggle');
                const statusText = document.getElementById('twoFactorStatusText');
                const statusDesc = document.getElementById('twoFactorStatusDescription');

                toggle.checked = enabled;

                if (enabled) {
                    statusText.textContent = 'Two-Factor Authentication Enabled';
                    statusText.className = 'text-success';
                    statusDesc.textContent = `${backupCodesRemaining} backup codes remaining`;
                } else {
                    statusText.textContent = 'Two-Factor Authentication Disabled';
                    statusText.className = '';
                    statusDesc.textContent = 'Enable for extra security';
                }
            }
        } catch (error) {
            console.error('Load 2FA status error:', error);
        }
    }

    document.getElementById('twoFactorToggle').addEventListener('change', async function() {
        const isEnabled = this.checked;

        if (isEnabled) {
            // Enable 2FA
            if (!confirm('Enable Two-Factor Authentication? You will receive a code via email each time you log in.')) {
                this.checked = false;
                return;
            }

            try {
                const response = await fetch('/api/auth/2fa/enable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    // Show backup codes
                    backupCodesData = result.data.backupCodes;
                    displayBackupCodes(result.data.backupCodes);
                    document.getElementById('backupCodesSection').classList.remove('d-none');

                    alert('Two-Factor Authentication enabled successfully! Please save your backup codes.');
                    await load2FAStatus();
                } else {
                    alert('Failed to enable 2FA: ' + result.message);
                    this.checked = false;
                }
            } catch (error) {
                console.error('Enable 2FA error:', error);
                alert('Failed to enable 2FA. Please try again.');
                this.checked = false;
            }
        } else {
            // Show disable form
            this.checked = true; // Keep it checked until password is verified
            document.getElementById('disableTwoFactorSection').classList.remove('d-none');
        }
    });

    function displayBackupCodes(codes) {
        const codesList = document.getElementById('backupCodesList');
        codesList.innerHTML = codes.map((code, index) =>
            `<div class="mb-1">${index + 1}. ${code}</div>`
        ).join('');
    }

    function printBackupCodes() {
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>PowerShare - Backup Codes</title>');
        printWindow.document.write('<style>body { font-family: monospace; padding: 20px; }</style>');
        printWindow.document.write('</head><body>');
        printWindow.document.write('<h2>PowerShare - Two-Factor Authentication Backup Codes</h2>');
        printWindow.document.write('<p>Store these codes in a safe place. Each code can only be used once.</p>');
        printWindow.document.write('<ul>');
        backupCodesData.forEach((code, index) => {
            printWindow.document.write(`<li>${code}</li>`);
        });
        printWindow.document.write('</ul>');
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    function downloadBackupCodes() {
        const text = 'PowerShare - Two-Factor Authentication Backup Codes\n\n' +
                     'Store these codes in a safe place. Each code can only be used once.\n\n' +
                     backupCodesData.map((code, index) => `${index + 1}. ${code}`).join('\n');

        const blob = new Blob([text], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'powershare-backup-codes.txt';
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function cancelDisable2FA() {
        document.getElementById('disableTwoFactorSection').classList.add('d-none');
        document.getElementById('disable2FAPassword').value = '';
    }

    document.getElementById('disableTwoFactorForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const password = document.getElementById('disable2FAPassword').value;

        try {
            const response = await fetch('/api/auth/2fa/disable', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ password })
            });

            const result = await response.json();

            if (result.success) {
                alert('Two-Factor Authentication disabled successfully');
                document.getElementById('twoFactorToggle').checked = false;
                document.getElementById('disableTwoFactorSection').classList.add('d-none');
                document.getElementById('backupCodesSection').classList.add('d-none');
                await load2FAStatus();
            } else {
                alert('Failed to disable 2FA: ' + result.message);
            }
        } catch (error) {
            console.error('Disable 2FA error:', error);
            alert('Failed to disable 2FA. Please try again.');
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        loadNotificationPreferences();
        load2FAStatus();

        const darkModeToggle = document.getElementById('darkModeToggle');
        if (darkModeToggle) {
            darkModeToggle.addEventListener('change', toggleThemeInstantly);
        }
    });
</script>

<style>
    .is-invalid {
        border-color: #dc3545 !important;
    }
    .validation-error {
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
</style>

<%- include('partials/footer') %>