<%- include('partials/head', { title: 'Generator Details - PowerShare' }) %>

<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="/dashboard">
            <i class="fas fa-shield-alt"></i> PowerShare Admin
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard">
                        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle me-1"></i>
                        <span><%= user.full_name || 'Admin' %></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="/profile">
                                <i class="fas fa-user me-2"></i>Profile Management
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item" href="/logout">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold mb-1">Generator Details</h2>
                    <p class="text-muted mb-0">View and manage generator information</p>
                </div>
                <div>
                    <button class="btn btn-outline-danger me-2" onclick="deleteGenerator()">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                    <button class="btn btn-primary" onclick="editGenerator()">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-industry me-2"></i>Generator Information</h5>
                </div>
                <div class="card-body" id="generatorInfoCard">
                    <div class="text-center py-4">
                        <div class="spinner-border text-success"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">Capacity</h6>
                            <h3 class="fw-bold text-primary mb-0" id="capacityStat">--</h3>
                            <small class="text-muted">kW</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">Subscribers</h6>
                            <h3 class="fw-bold text-success mb-0" id="subscribersStat">--</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center">
                            <h6 class="text-muted mb-2">Status</h6>
                            <h5 class="mb-0" id="statusBadge">
                                <span class="badge bg-success">Active</span>
                            </h5>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold mb-0"><i class="fas fa-dollar-sign me-2"></i>Pricing Plans</h5>
                </div>
                <div class="card-body">
                    <div id="pricingPlansTable">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="fw-bold mb-0"><i class="fas fa-users me-2"></i>Recent Subscribers</h5>
                </div>
                <div class="card-body">
                    <div id="subscribersTable">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editGeneratorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Generator</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editGeneratorForm">
                    <div class="mb-3">
                        <label class="form-label">Generator Name</label>
                        <input type="text" class="form-control" id="editGeneratorName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control" id="editLocation" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Capacity (kW)</label>
                        <input type="number" class="form-control" id="editCapacity" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveGeneratorEdit()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<%- include('partials/footer') %>

<script>
    const genId = <%= genId %>;
    let currentGenerator = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadGeneratorDetails();
        loadPricingPlans();
    });

    async function loadGeneratorDetails() {
        try {
            const response = await fetch(`/api/admin/generators/${genId}`);
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.message || 'Failed to load generator details');
            }

            currentGenerator = data.data;
            const generatorInfo = document.getElementById('generatorInfoCard');
            
            const statusBadgeClass = currentGenerator.status === 'active' ? 'bg-success' : 'bg-secondary';
            const statusText = capitalizeFirst(currentGenerator.status || 'active');

            generatorInfo.innerHTML = `
                <div class="text-center mb-3">
                    <div class="generator-icon mx-auto mb-3">
                        <i class="fas fa-industry fa-3x text-success"></i>
                    </div>
                    <h5 class="mb-1">${currentGenerator.generator_name || 'N/A'}</h5>
                    <span class="badge ${statusBadgeClass}">${statusText}</span>
                </div>
                <hr>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Generator ID</small>
                    <div>#${currentGenerator.generator_id}</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Location</small>
                    <div><i class="fas fa-map-marker-alt text-danger me-2"></i>${currentGenerator.location || 'Not specified'}</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Capacity</small>
                    <div>${currentGenerator.capacity_kw || 'N/A'} kW</div>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Owner</small>
                    <div>
                        ${currentGenerator.owner_name || 'Not specified'}
                        ${currentGenerator.owner_email ? `<br><small class="text-muted">${currentGenerator.owner_email}</small>` : ''}
                        ${currentGenerator.owner_phone ? `<br><small class="text-muted">${currentGenerator.owner_phone}</small>` : ''}
                    </div>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block mb-1">Created Date</small>
                    <div>${formatDate(currentGenerator.created_at)}</div>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Total Revenue</span>
                    <span class="fw-bold text-success">$${parseFloat(currentGenerator.revenue_stats?.total_revenue || 0).toFixed(2)}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Monthly Revenue</span>
                    <span class="fw-bold">$${parseFloat(currentGenerator.revenue_stats?.monthly_revenue || 0).toFixed(2)}</span>
                </div>
            `;

            document.getElementById('capacityStat').textContent = currentGenerator.capacity_kw || '--';
            document.getElementById('subscribersStat').textContent = currentGenerator.subscribers ? currentGenerator.subscribers.length : '0';
            document.getElementById('statusBadge').innerHTML = `<span class="badge ${statusBadgeClass}">${statusText}</span>`;
            
            loadSubscribers(currentGenerator.subscribers);

        } catch (error) {
            console.error('Load generator error:', error);
            document.getElementById('generatorInfoCard').innerHTML = `
                <div class="alert alert-danger mb-0">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error loading generator details: ${error.message}
                </div>
            `;
        }
    }

    function loadSubscribers(subscribers) {
        const subscribersTable = document.getElementById('subscribersTable');
        
        if (!subscribers || subscribers.length === 0) {
            subscribersTable.innerHTML = `
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    No subscribers yet.
                </div>
            `;
            return;
        }
        
        subscribersTable.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Plan</th>
                            <th>Status</th>
                            <th>Start Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${subscribers.slice(0, 10).map(sub => `
                            <tr>
                                <td>${sub.full_name}</td>
                                <td><small>${sub.email}</small></td>
                                <td><span class="badge bg-primary">${sub.plan_name} (${sub.amperage}A)</span></td>
                                <td><span class="badge ${sub.status === 'active' ? 'bg-success' : 'bg-secondary'}">${capitalizeFirst(sub.status)}</span></td>
                                <td>${formatDate(sub.start_date)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${subscribers.length > 10 ? `<div class="text-center mt-2"><small class="text-muted">Showing 10 of ${subscribers.length} subscribers</small></div>` : ''}
            </div>
        `;
    }

    async function loadPricingPlans() {
        try {
            const pricingPlansTable = document.getElementById('pricingPlansTable');
            pricingPlansTable.innerHTML = `
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Pricing plans management is available through the pricing plans section.
                </div>
            `;
        } catch (error) {
            console.error('Load pricing plans error:', error);
        }
    }
    
    function capitalizeFirst(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function editGenerator() {
        if (!currentGenerator) {
            showNotification('Generator data not loaded', 'danger');
            return;
        }

        document.getElementById('editGeneratorName').value = currentGenerator.generator_name || currentGenerator.name || '';
        document.getElementById('editLocation').value = currentGenerator.location || '';
        document.getElementById('editCapacity').value = currentGenerator.capacity_kw || '';

        const modal = new bootstrap.Modal(document.getElementById('editGeneratorModal'));
        modal.show();
    }

    async function saveGeneratorEdit() {
        try {
            const generator_name = document.getElementById('editGeneratorName').value;
            const location = document.getElementById('editLocation').value;
            const capacity_kw = document.getElementById('editCapacity').value;

            const response = await fetch(`/api/generators/${genId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    generator_name,
                    location,
                    capacity_kw
                })
            });

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.message);
            }

            showNotification('Generator updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editGeneratorModal')).hide();
            
            setTimeout(() => location.reload(), 1000);

        } catch (error) {
            console.error('Update generator error:', error);
            showNotification('Failed to update generator: ' + error.message, 'danger');
        }
    }

    async function deleteGenerator() {
        if (!confirm('Are you sure you want to delete this generator? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`/api/generators/${genId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (!data.success) {
                throw new Error(data.message);
            }

            showNotification('Generator deleted successfully!', 'success');
            setTimeout(() => window.location.href = '/dashboard', 1500);

        } catch (error) {
            console.error('Delete generator error:', error);
            showNotification('Failed to delete generator: ' + error.message, 'danger');
        }
    }

    function formatDate(dateString) {
        if (!dateString) return '--';
        return new Date(dateString).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    }
</script>

<style>
    .generator-icon {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #f0fff4;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
</body>
</html>

